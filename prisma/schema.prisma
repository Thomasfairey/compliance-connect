// Compliance Connect - Prisma Schema
// PostgreSQL hosted on Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CUSTOMER
  ENGINEER
  ADMIN
}

enum BookingStatus {
  PENDING         // Created, awaiting engineer assignment
  CONFIRMED       // Engineer assigned, job accepted
  EN_ROUTE        // Engineer traveling to site
  ON_SITE         // Engineer arrived at site
  IN_PROGRESS     // Work in progress
  COMPLETED       // Job finished successfully
  CANCELLED       // Job cancelled
  DECLINED        // Engineer declined the job
  REQUIRES_REVISIT // Needs another visit to complete
}

enum EngineerStatus {
  PENDING_APPROVAL
  APPROVED
  SUSPENDED
  REJECTED
}

enum EngineerType {
  PAT_TESTER      // 45p per test
  ELECTRICIAN     // 40% of labour
  CONSULTANT      // Day rate (£400)
  GENERAL
}

model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  name          String
  email         String    @unique
  role          Role      @default(CUSTOMER)
  companyName   String?
  phone         String?
  avatarUrl     String?
  sites         Site[]
  bookings      Booking[] @relation("CustomerBookings")
  assignments   Booking[] @relation("EngineerBookings")

  // Engineer-specific fields
  engineerProfile EngineerProfile?

  // Bundle purchases
  bundles       BookingBundle[] @relation("CustomerBundles")

  // Compliance tracking
  reminders     ComplianceReminder[] @relation("CustomerReminders")
  upsells       UpsellSuggestion[]   @relation("CustomerUpsells")

  // Push notifications
  pushSubscriptions PushSubscription[]
  notifications     Notification[]

  // Scheduling V2: Customer metrics for LTV scoring
  customerMetrics   CustomerMetrics?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model EngineerProfile {
  id              String         @id @default(cuid())
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Status
  status          EngineerStatus @default(PENDING_APPROVAL)
  approvedAt      DateTime?
  rejectedReason  String?

  // Professional Info
  yearsExperience Int            @default(0)
  bio             String?

  // Qualifications
  qualifications  EngineerQualification[]

  // Service Competencies - which services they can perform
  competencies    EngineerCompetency[]

  // Geographic Coverage
  coverageAreas   EngineerCoverageArea[]

  // Calendar/Availability
  calendarSyncs   CalendarSync[]
  availability    EngineerAvailability[]

  // Rates and compensation
  dayRate         Float?
  engineerType    EngineerType   @default(GENERAL)
  testRate        Float?         @default(0.45)  // For PAT testers: £ per test
  labourPercentage Float?        @default(0.40)  // For electricians: % of labour

  // Relations for compensation tracking
  patTestLogs     PATTestLog[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([engineerType])
}

model EngineerQualification {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  name              String           // e.g., "18th Edition", "City & Guilds 2391"
  issuingBody       String?          // e.g., "City & Guilds", "NICEIC"
  certificateNumber String?
  issueDate         DateTime?
  expiryDate        DateTime?
  verified          Boolean          @default(false)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([engineerProfileId])
}

model EngineerCompetency {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  serviceId         String
  service           Service          @relation(fields: [serviceId], references: [id])

  experienceYears   Int              @default(0)
  certified         Boolean          @default(false)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([engineerProfileId, serviceId])
  @@index([engineerProfileId])
}

model EngineerCoverageArea {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  // Postcode prefix or area
  postcodePrefix    String           // e.g., "SW1", "EC", "W"

  // For proximity calculations
  centerLat         Float?
  centerLng         Float?
  radiusKm          Float            @default(20)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([engineerProfileId, postcodePrefix])
  @@index([engineerProfileId])
  @@index([postcodePrefix])
}

model CalendarSync {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  provider          String           // "google", "apple", "outlook"
  calendarId        String?
  accessToken       String?          // Encrypted in real app
  refreshToken      String?          // Encrypted in real app
  expiresAt         DateTime?

  lastSyncedAt      DateTime?
  syncEnabled       Boolean          @default(true)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([engineerProfileId])
}

model EngineerAvailability {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  date              DateTime         @db.Date
  slot              String           // "AM", "PM", "FULL_DAY"
  isAvailable       Boolean          @default(true)

  // If blocked from calendar sync
  calendarEventId   String?
  calendarEventTitle String?

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([engineerProfileId, date, slot])
  @@index([engineerProfileId])
  @@index([date])
  @@index([isAvailable])
}

model Site {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String    // e.g., "London HQ"
  address     String
  postcode    String

  // For proximity calculations
  latitude    Float?
  longitude   Float?

  accessNotes String?
  bookings    Booking[]

  // Site profile for intelligent recommendations
  profile     SiteProfile?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([postcode])
}

model Service {
  id              String    @id @default(cuid())
  name            String    // e.g., "PAT Testing"
  slug            String    @unique // e.g., "pat-testing"
  description     String
  basePrice       Float     // Per unit price
  minCharge       Float     // Minimum visit charge
  unitName        String    // e.g., "item"
  icon            String?   // Lucide icon name
  isActive        Boolean   @default(true)

  // Duration calculation parameters
  baseMinutes     Int       @default(30)     // Base time for the job
  minutesPerUnit  Float     @default(2)      // Minutes per unit (item, circuit, etc.)

  // Compliance interval in months (for auto-rebook feature)
  complianceIntervalMonths Int? // e.g., 12 for annual PAT testing

  bookings        Booking[]
  competencies    EngineerCompetency[]
  bundleItems     BundleItem[]
  reportTemplates ReportTemplate[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Booking {
  id            String        @id @default(cuid())
  reference     String        @unique @default(cuid())
  status        BookingStatus @default(PENDING)

  customerId    String
  customer      User          @relation("CustomerBookings", fields: [customerId], references: [id], onDelete: Cascade)

  siteId        String
  site          Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)

  serviceId     String
  service       Service       @relation(fields: [serviceId], references: [id])

  scheduledDate DateTime
  slot          String        // "AM" or "PM"

  // Duration
  estimatedDuration Int?      // In minutes

  estimatedQty  Int
  quotedPrice   Float

  // Dynamic pricing
  discountPercent Float       @default(0)
  originalPrice   Float?

  // Provisional booking support
  isProvisional     Boolean     @default(false)
  provisionalUntil  DateTime?   // Date until booking can be shifted
  confirmedAt       DateTime?   // When provisional became confirmed

  engineerId    String?
  engineer      User?         @relation("EngineerBookings", fields: [engineerId], references: [id])

  // Additional notes from customer
  notes         String?

  // Execution Timestamps
  acceptedAt    DateTime?   // When engineer accepted
  enRouteAt     DateTime?   // When engineer started traveling
  arrivedAt     DateTime?   // When engineer arrived on site
  startedAt     DateTime?   // When work began
  completedAt   DateTime?   // When job finished
  certificateUrl String?

  // If declined or requires revisit
  declinedAt    DateTime?
  declinedReason String?
  revisitReason String?

  // Engineer uploaded documents
  engineerNotes String?
  uploadedDocsUrl String?

  // Customer signature on completion
  customerSignatureUrl String?
  customerSignedBy     String?
  customerSignedAt     DateTime?

  assets        Asset[]
  evidence      JobEvidence[]
  statusLogs    BookingStatusLog[]
  patTestLog    PATTestLog?
  reports       GeneratedReport[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([customerId])
  @@index([engineerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([siteId])
  @@index([isProvisional])
}

model Asset {
  id          String   @id @default(cuid())
  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  assetTag    String?  // Unique identifier for the asset
  name        String   // e.g., "Kettle"
  location    String   // e.g., "Kitchen"
  status      String   // "PASS" | "FAIL" | "N/A"
  notes       String?
  imageUrl    String?
  testedAt    DateTime @default(now())

  evidence    JobEvidence[]

  @@index([bookingId])
}

model JobEvidence {
  id          String   @id @default(cuid())
  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  assetId     String?
  asset       Asset?   @relation(fields: [assetId], references: [id], onDelete: SetNull)

  type        String   // "PHOTO" | "SIGNATURE" | "DOCUMENT" | "TEST_RESULT"
  fileUrl     String
  fileName    String
  mimeType    String
  description String?

  uploadedBy  String
  uploadedAt  DateTime @default(now())

  @@index([bookingId])
  @@index([assetId])
  @@index([type])
}

// =====================
// FEATURE 1: SERVICE BUNDLES
// =====================

model ServiceBundle {
  id              String       @id @default(cuid())
  name            String       // e.g., "Annual Compliance Package"
  slug            String       @unique
  description     String
  discountPercent Float        @default(0) // Bundle discount (e.g., 15)
  isActive        Boolean      @default(true)
  icon            String?      // Lucide icon name
  sortOrder       Int          @default(0)

  // Which industries/building types this bundle is recommended for
  recommendedFor  String[]     @default([])

  items           BundleItem[]
  bookings        BookingBundle[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model BundleItem {
  id              String        @id @default(cuid())
  bundleId        String
  bundle          ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  serviceId       String
  service         Service       @relation(fields: [serviceId], references: [id])

  // Override default quantity/pricing for this bundle
  includedQty     Int?          // null = based on site profile
  isRequired      Boolean       @default(true)

  @@unique([bundleId, serviceId])
  @@index([bundleId])
}

model BookingBundle {
  id              String        @id @default(cuid())
  bundleId        String
  bundle          ServiceBundle @relation(fields: [bundleId], references: [id])

  // Link to the individual bookings created from this bundle
  bookingIds      String[]

  customerId      String
  customer        User          @relation("CustomerBundles", fields: [customerId], references: [id], onDelete: Cascade)

  siteId          String

  totalOriginalPrice  Float
  totalDiscountedPrice Float
  discountPercent     Float

  purchasedAt     DateTime      @default(now())

  @@index([customerId])
  @@index([bundleId])
}

// =====================
// FEATURE 2: SITE PROFILES & QUESTIONNAIRE
// =====================

enum BuildingType {
  OFFICE
  RETAIL
  WAREHOUSE
  RESTAURANT
  HOTEL
  HEALTHCARE
  EDUCATION
  MANUFACTURING
  RESIDENTIAL
  MIXED_USE
  OTHER
}

enum IndustryType {
  TECHNOLOGY
  FINANCE
  HEALTHCARE
  HOSPITALITY
  RETAIL
  MANUFACTURING
  EDUCATION
  GOVERNMENT
  PROFESSIONAL_SERVICES
  OTHER
}

model SiteProfile {
  id              String        @id @default(cuid())
  siteId          String        @unique
  site            Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Building Information
  buildingType    BuildingType  @default(OTHER)
  industryType    IndustryType  @default(OTHER)

  // Size metrics
  floorArea       Int?          // Square meters
  numberOfFloors  Int?
  numberOfRooms   Int?

  // Compliance-relevant details
  hasCommercialKitchen  Boolean @default(false)
  hasServerRoom         Boolean @default(false)
  hasWorkshop           Boolean @default(false)
  hasPublicAccess       Boolean @default(false)
  yearBuilt             Int?
  lastRefurbishment     Int?

  // Estimated quantities (used for auto-quoting)
  estimatedPATItems         Int?
  estimatedFireZones        Int?
  estimatedEmergencyLights  Int?
  estimatedCircuits         Int?
  estimatedExtinguishers    Int?
  estimatedCCTVCameras      Int?

  // Staff/occupancy
  typicalOccupancy      Int?
  numberOfWorkstations  Int?

  // Gov.uk EPC data (future integration)
  epcRating             String?
  epcCertificateNumber  String?

  // Questionnaire completion tracking
  questionnaireComplete Boolean   @default(false)
  completedAt           DateTime?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// =====================
// FEATURE 3: ALLOCATION & ROUTE OPTIMIZATION
// =====================

model AllocationLog {
  id              String    @id @default(cuid())
  bookingId       String

  // What happened
  action          String    // "AUTO_ASSIGNED", "REALLOCATED", "MANUAL_OVERRIDE"

  // Who was involved
  fromEngineerId  String?
  toEngineerId    String?

  // Why it happened
  reason          String?   // e.g., "Closest available", "Skill match", "Route optimization"
  score           Float?    // Allocation score for debugging

  // Additional context
  metadata        Json?     // Travel time, distance, etc.

  createdAt       DateTime  @default(now())

  @@index([bookingId])
  @@index([toEngineerId])
}

// =====================
// FEATURE 4: AUTO-REBOOK & COMPLIANCE TRACKING
// =====================

model ComplianceReminder {
  id              String    @id @default(cuid())

  customerId      String
  customer        User      @relation("CustomerReminders", fields: [customerId], references: [id], onDelete: Cascade)

  siteId          String
  serviceId       String

  // Last test details
  lastBookingId   String?
  lastTestDate    DateTime?

  // Next due date (calculated from compliance interval)
  nextDueDate     DateTime

  // Notification status
  reminderSent30Days  Boolean   @default(false)
  reminderSent7Days   Boolean   @default(false)
  reminderSentOverdue Boolean   @default(false)

  // Auto-rebook preference
  autoRebookEnabled   Boolean   @default(false)
  preferredSlot       String?   // "AM", "PM", or specific time
  preferredDayOfWeek  Int?      // 0-6

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([siteId, serviceId])
  @@index([customerId])
  @@index([nextDueDate])
}

model UpsellSuggestion {
  id              String    @id @default(cuid())

  customerId      String
  customer        User      @relation("CustomerUpsells", fields: [customerId], references: [id], onDelete: Cascade)

  siteId          String
  serviceId       String    // The suggested service

  // Why we're suggesting this
  reason          String    // e.g., "Based on your site profile", "Required by law for your industry"
  priority        Int       @default(0) // Higher = more important

  // Status
  status          String    @default("PENDING") // "PENDING", "ACCEPTED", "DISMISSED"
  dismissedAt     DateTime?
  acceptedAt      DateTime?

  // Link to resulting booking if accepted
  bookingId       String?

  createdAt       DateTime  @default(now())

  @@index([customerId])
  @@index([status])
}

// =====================
// FEATURE 5: ENHANCED ENGINEER APP
// =====================

model PushSubscription {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Web Push subscription details
  endpoint        String
  p256dh          String    // Public key
  auth            String    // Auth secret

  // Device info
  deviceName      String?
  userAgent       String?

  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model Notification {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            String    // "NEW_JOB", "SCHEDULE_CHANGE", "REMINDER", etc.
  title           String
  body            String

  // Link to related entity
  bookingId       String?

  // Delivery status
  sentAt          DateTime?
  readAt          DateTime?

  // For action buttons
  actionUrl       String?
  actionLabel     String?

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([readAt])
}

// =====================
// FEATURE 6: PAT TEST LOGGING & COMPENSATION
// =====================

model PATTestLog {
  id              String           @id @default(cuid())
  bookingId       String           @unique
  booking         Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  engineerProfileId String
  engineerProfile   EngineerProfile @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  itemsTested     Int
  ratePerTest     Float            @default(0.45)  // £0.45 per test
  totalEarnings   Float                            // itemsTested * ratePerTest

  loggedAt        DateTime         @default(now())
  approvedAt      DateTime?
  approvedBy      String?          // Admin user ID

  notes           String?

  @@index([engineerProfileId])
  @@index([loggedAt])
}

// =====================
// FEATURE 7: REPORT TEMPLATES & GENERATION
// =====================

model ReportTemplate {
  id              String    @id @default(cuid())
  name            String    // e.g., "Fire Risk Assessment Report"
  slug            String    @unique

  serviceId       String
  service         Service   @relation(fields: [serviceId], references: [id])

  // Template structure
  content         String    @db.Text    // Markdown/HTML template
  sections        Json                  // Array of section definitions
  fieldMappings   Json                  // Maps template fields to booking/asset data

  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)

  reports         GeneratedReport[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([serviceId])
}

model GeneratedReport {
  id              String          @id @default(cuid())
  bookingId       String
  booking         Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  templateId      String
  template        ReportTemplate  @relation(fields: [templateId], references: [id])

  // Generated content
  content         String          @db.Text
  pdfUrl          String?

  // Metadata
  generatedBy     String?         // Engineer user ID
  generatedAt     DateTime        @default(now())
  finalizedAt     DateTime?

  @@index([bookingId])
  @@index([templateId])
}

// =====================
// BOOKING STATUS HISTORY
// =====================

model BookingStatusLog {
  id          String         @id @default(cuid())
  bookingId   String
  booking     Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  fromStatus  BookingStatus?
  toStatus    BookingStatus
  changedBy   String         // User ID who made the change
  reason      String?        // Optional reason for status change

  createdAt   DateTime       @default(now())

  @@index([bookingId])
  @@index([createdAt])
}

// =====================
// FEATURE 8: SCHEDULING INTELLIGENCE V2
// =====================

// Customer Metrics for LTV and reliability scoring
model CustomerMetrics {
  id                  String    @id @default(cuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Booking counts
  totalBookings       Int       @default(0)
  completedBookings   Int       @default(0)
  cancelledBookings   Int       @default(0)
  declinedBookings    Int       @default(0)

  // Revenue metrics
  totalRevenue        Float     @default(0)
  averageOrderValue   Float     @default(0)

  // Timeline
  firstBookingAt      DateTime?
  lastBookingAt       DateTime?
  daysSinceLastBooking Int?

  // Derived scores (0-100)
  ltvScore            Float     @default(50)   // Lifetime value score
  reliabilityScore    Float     @default(50)   // Based on cancellation rate
  frequencyScore      Float     @default(50)   // How often they book

  // Recalculation tracking
  calculatedAt        DateTime  @default(now())

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([ltvScore])
  @@index([reliabilityScore])
}

// Extensible pricing rules - stored in DB, not hardcoded
model PricingRule {
  id          String   @id @default(cuid())
  name        String   // e.g., "Cluster Discount", "Urgency Premium"
  slug        String   @unique
  description String?

  // Rule type determines calculation logic
  type        String   // 'cluster', 'urgency', 'offpeak', 'bundle', 'flex', 'loyalty'

  // Configuration as JSON for flexibility
  // Examples:
  // cluster: { radiusKm: 5, minJobs: 2, discountPercent: 10 }
  // urgency: { daysThreshold: 2, premiumPercent: 15 }
  // offpeak: { days: [1, 2, 3], discountPercent: 5 }
  config      Json

  // Control
  enabled     Boolean  @default(true)
  priority    Int      @default(0)  // Higher = applied later (can override)

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@index([type])
}

// Detailed scoring log for V2 allocation decisions
model AllocationScoreLog {
  id              String   @id @default(cuid())
  bookingId       String
  engineerId      String

  // Composite scores
  customerScore   Float
  engineerScore   Float
  platformScore   Float
  compositeScore  Float

  // Weights used
  customerWeight  Float    @default(0.40)
  engineerWeight  Float    @default(0.30)
  platformWeight  Float    @default(0.30)

  // Individual factor scores (JSON for flexibility)
  // { factorName: { rawValue, normalizedScore, weight, contribution } }
  factors         Json

  // Was this the selected allocation?
  wasSelected     Boolean  @default(false)

  // Comparison with V1 (for shadow mode)
  v1Score         Float?
  v1Rank          Int?
  v2Rank          Int?

  createdAt       DateTime @default(now())

  @@index([bookingId])
  @@index([engineerId])
  @@index([wasSelected])
  @@index([createdAt])
}

// Area intelligence for network effect scoring
model AreaIntelligence {
  id                  String   @id @default(cuid())
  postcodeDistrict    String   @unique  // e.g., "SW1A", "EC2M"

  // Business density estimates
  estimatedBusinesses Int      @default(0)
  businessDensityTier String   @default("unknown") // 'high', 'medium', 'low', 'unknown'

  // Our penetration
  totalCustomers      Int      @default(0)
  totalBookings       Int      @default(0)
  penetrationRate     Float    @default(0)

  // Historical performance
  avgJobValue         Float?
  cancellationRate    Float?

  // Categorization
  primaryIndustry     String?  // 'office', 'retail', 'mixed', etc.
  repeatFactor        Float    @default(1.0)  // Expected repeat booking rate

  // Recalculation tracking
  calculatedAt        DateTime @default(now())

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([businessDensityTier])
  @@index([penetrationRate])
}
