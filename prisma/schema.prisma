// Compliance Connect - Prisma Schema
// PostgreSQL hosted on Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CUSTOMER
  ENGINEER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum EngineerStatus {
  PENDING_APPROVAL
  APPROVED
  SUSPENDED
  REJECTED
}

model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  name          String
  email         String    @unique
  role          Role      @default(CUSTOMER)
  companyName   String?
  phone         String?
  avatarUrl     String?
  sites         Site[]
  bookings      Booking[] @relation("CustomerBookings")
  assignments   Booking[] @relation("EngineerBookings")

  // Engineer-specific fields
  engineerProfile EngineerProfile?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model EngineerProfile {
  id              String         @id @default(cuid())
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Status
  status          EngineerStatus @default(PENDING_APPROVAL)
  approvedAt      DateTime?
  rejectedReason  String?

  // Professional Info
  yearsExperience Int            @default(0)
  bio             String?

  // Qualifications
  qualifications  EngineerQualification[]

  // Service Competencies - which services they can perform
  competencies    EngineerCompetency[]

  // Geographic Coverage
  coverageAreas   EngineerCoverageArea[]

  // Calendar/Availability
  calendarSyncs   CalendarSync[]
  availability    EngineerAvailability[]

  // Rates
  dayRate         Float?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
}

model EngineerQualification {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  name              String           // e.g., "18th Edition", "City & Guilds 2391"
  issuingBody       String?          // e.g., "City & Guilds", "NICEIC"
  certificateNumber String?
  issueDate         DateTime?
  expiryDate        DateTime?
  verified          Boolean          @default(false)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([engineerProfileId])
}

model EngineerCompetency {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  serviceId         String
  service           Service          @relation(fields: [serviceId], references: [id])

  experienceYears   Int              @default(0)
  certified         Boolean          @default(false)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([engineerProfileId, serviceId])
  @@index([engineerProfileId])
}

model EngineerCoverageArea {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  // Postcode prefix or area
  postcodePrefix    String           // e.g., "SW1", "EC", "W"

  // For proximity calculations
  centerLat         Float?
  centerLng         Float?
  radiusKm          Float            @default(20)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([engineerProfileId, postcodePrefix])
  @@index([engineerProfileId])
  @@index([postcodePrefix])
}

model CalendarSync {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  provider          String           // "google", "apple", "outlook"
  calendarId        String?
  accessToken       String?          // Encrypted in real app
  refreshToken      String?          // Encrypted in real app
  expiresAt         DateTime?

  lastSyncedAt      DateTime?
  syncEnabled       Boolean          @default(true)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([engineerProfileId])
}

model EngineerAvailability {
  id                String           @id @default(cuid())
  engineerProfileId String
  engineerProfile   EngineerProfile  @relation(fields: [engineerProfileId], references: [id], onDelete: Cascade)

  date              DateTime         @db.Date
  slot              String           // "AM", "PM", "FULL_DAY"
  isAvailable       Boolean          @default(true)

  // If blocked from calendar sync
  calendarEventId   String?
  calendarEventTitle String?

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@unique([engineerProfileId, date, slot])
  @@index([engineerProfileId])
  @@index([date])
  @@index([isAvailable])
}

model Site {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String    // e.g., "London HQ"
  address     String
  postcode    String

  // For proximity calculations
  latitude    Float?
  longitude   Float?

  accessNotes String?
  bookings    Booking[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([postcode])
}

model Service {
  id              String    @id @default(cuid())
  name            String    // e.g., "PAT Testing"
  slug            String    @unique // e.g., "pat-testing"
  description     String
  basePrice       Float     // Per unit price
  minCharge       Float     // Minimum visit charge
  unitName        String    // e.g., "item"
  icon            String?   // Lucide icon name
  isActive        Boolean   @default(true)

  // Duration calculation parameters
  baseMinutes     Int       @default(30)     // Base time for the job
  minutesPerUnit  Float     @default(2)      // Minutes per unit (item, circuit, etc.)

  bookings        Booking[]
  competencies    EngineerCompetency[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Booking {
  id            String        @id @default(cuid())
  reference     String        @unique @default(cuid())
  status        BookingStatus @default(PENDING)

  customerId    String
  customer      User          @relation("CustomerBookings", fields: [customerId], references: [id], onDelete: Cascade)

  siteId        String
  site          Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)

  serviceId     String
  service       Service       @relation(fields: [serviceId], references: [id])

  scheduledDate DateTime
  slot          String        // "AM" or "PM"

  // Duration
  estimatedDuration Int?      // In minutes

  estimatedQty  Int
  quotedPrice   Float

  // Dynamic pricing
  discountPercent Float       @default(0)
  originalPrice   Float?

  engineerId    String?
  engineer      User?         @relation("EngineerBookings", fields: [engineerId], references: [id])

  // Additional notes from customer
  notes         String?

  // Execution Data
  startedAt     DateTime?
  completedAt   DateTime?
  certificateUrl String?

  // Engineer uploaded documents
  engineerNotes String?
  uploadedDocsUrl String?

  assets        Asset[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([customerId])
  @@index([engineerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([siteId])
}

model Asset {
  id          String   @id @default(cuid())
  bookingId   String
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  assetTag    String?  // Unique identifier for the asset
  name        String   // e.g., "Kettle"
  location    String   // e.g., "Kitchen"
  status      String   // "PASS" | "FAIL" | "N/A"
  notes       String?
  imageUrl    String?
  testedAt    DateTime @default(now())

  @@index([bookingId])
}
